{% extends 'layouts/dashboard.html' %}
{% block title %}Panel RRHH{% endblock %}

{% block dashboard_content %}
<div class="mb-4">
    <h1 class="h2">Panel de Recursos Humanos</h1>
    <p class="text-muted">Bienvenido, {{ current_user.username }}</p>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Distribución de Personal por Unidad Administrativa</h5>
            </div>
            <div class="card-body">
                <canvas id="empleadosUnidadChart" width="400" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Resumen</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Total de empleados:</strong>
                    <span class="badge bg-primary fs-6 float-end">
                        {{ empleados_unidad | sum(attribute='cantidad') }}
                    </span>
                </div>
                <div class="mb-3">
                    <strong>Total de unidades:</strong>
                    <span class="badge bg-success fs-6 float-end">
                        {{ empleados_unidad | length }}
                    </span>
                </div>
                <hr>
                <h6>Detalle por unidad:</h6>
                <div style="max-height: 300px; overflow-y: auto;">
                    {% for unidad in empleados_unidad %}
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="small">{{ unidad.nombre_unidad }}</span>
                        <span class="badge bg-secondary">{{ unidad.cantidad }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cargar Chart.js desde CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('empleadosUnidadChart').getContext('2d');
        
        const labels = {{ empleados_unidad | map(attribute='nombre_unidad') | list | tojson | safe }};
        const dataValues = {{ empleados_unidad | map(attribute='cantidad') | list | tojson | safe }};

        // Colores para el gráfico
        const backgroundColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
            '#7CFC00', '#20B2AA', '#FF69B4', '#8A2BE2',
            '#00FF7F', '#1E90FF', '#FFD700', '#FF6347'
        ];

        const chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: dataValues,
                    backgroundColor: backgroundColors,
                    borderColor: '#ffffff',
                    borderWidth: 2,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateScale: true,
                    animateRotate: true
                }
            }
        });
    });
</script>

<style>
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }
</style>
{% endblock %}